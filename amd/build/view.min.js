define(["jquery","jqueryui","core/str","mod_englishcentral/html"],function(a,b,c,d){var e={};return e.plugin="mod_englishcentral",e.playercontainer="id_playercontainer",e.progresscontainer="id_progresscontainer",e.searchcontainer="id_searchcontainer",e.searchpage=0,e.searchsize=20,e.searchterm="",e.searchlevel="",e.str={},c.get_strings([{key:"addthisvideo",component:e.plugin},{key:"advanced",component:e.plugin},{key:"beginner",component:e.plugin},{key:"clickwhenfinished",component:e.plugin},{key:"confirmremovevideo",component:e.plugin},{key:"copyright",component:e.plugin},{key:"description",component:e.plugin},{key:"duration",component:"search"},{key:"goals",component:e.plugin},{key:"hideadvanced",component:"form"},{key:"intermediate",component:e.plugin},{key:"level",component:e.plugin},{key:"search",component:"moodle"},{key:"showadvanced",component:"form"},{key:"topics",component:e.plugin},{key:"transcript",component:e.plugin},{key:"videosearch",component:e.plugin},{key:"videosearchhelp",component:e.plugin},{key:"videosearchprompt",component:e.plugin}]).done(function(a){var b=0;e.str.addthisvideo=a[b++],e.str.advanced=a[b++],e.str.beginner=a[b++],e.str.clickwhenfinished=a[b++],e.str.confirmremovevideo=a[b++],e.str.copyright=a[b++],e.str.description=a[b++],e.str.duration=a[b++],e.str.goals=a[b++],e.str.hideadvanced=a[b++],e.str.intermediate=a[b++],e.str.level=a[b++],e.str.search=a[b++],e.str.showadvanced=a[b++],e.str.topics=a[b++],e.str.transcript=a[b++],e.str.videosearch=a[b++],e.str.videosearchhelp=a[b++],e.str.videosearchprompt=a[b++]}),e.init=function(b){for(var c in b)e[c]=b[c];a(".activity-title, .thumb-frame").click(function(a){return e.play_video(a,this),a.stopPropagation(),a.preventDefault(),!1}),a(".englishcentral_videos").sortable({cursor:"move",items:".activity-thumbnail",update:function(b,c){var d=c.item.find(".activity-title").prop("href"),f={dialogId:e.get_videoid_from_href(d),sortorder:c.item.index()+1};a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:f,action:"sortvideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b&&a("#"+e.playercontainer).html(b)}})}}),a(".removevideo").droppable({drop:function(b,c){if(confirm(e.str.confirmremovevideo)){c.draggable.remove();var d=c.draggable.find(".activity-title").prop("href"),f={dialogId:e.get_videoid_from_href(d)};a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:f,action:"removevideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b&&a("#"+e.playercontainer).html(b)}})}}}),a("#"+e.searchcontainer+" .search-form").submit(function(b){var c=a("#id_searchterm").val(),d=new RegExp("^s*[0-9]+([, \\t\\r\\n]+[0-9]+)*s*$"),f=a("[name='level[]']:checked").map(function(){return this.value}).get().join(",");""==c?a(".search-results").html(e.str.videosearchhelp):c.match(d)?e.fetch_videos(null,null,c,f):e.search_videos(null,null,c,f),b.preventDefault()}),a("#"+e.searchcontainer+" .search-advanced").click(function(){a(this).text()==e.str.showadvanced?a(this).text(e.str.hideadvanced):a(this).text(e.str.showadvanced),a("#"+e.searchcontainer+" .search-fields").find("dt:not(.visible), dd:not(.visible)").toggle()})},e.play_video=function(b,c){a("#"+e.playercontainer).html("");var d="setOnModeEndHandler";window.ECSDK.setOnProgressEventHandler&&(d="setOnProgressEventHandler"),window.ECSDK[d](function(b){switch(b.eventType){case"CompleteActivityWatch":case"LearnedWord":case"DialogLineSpeak":break;case"DialogLineWatch":var c=".thumb-frame[href$="+b.dialogID+"]";if(a(c+" .watch-status").length)return!1;break;case"CompleteActivityLearn":case"CompleteActivitySpeak":return!1;case"StartActivityWatch":case"StartActivityLearn":case"TypedWord":case"StudiedWord":case"StartActivitySpeak":return!1}a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"storeresults",sesskey:e.moodlesesskey},dataType:"html",success:function(b){b.indexOf("englishcentral_progress")<0?a(".englishcentral_progress").html(b):a(".englishcentral_progress").replaceWith(b)}}).then(function(){a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"showstatus",sesskey:e.moodlesesskey},dataType:"html",success:function(c){var d=a(".thumb-frame[href$="+b.dialogID+"]");d.find(".watch-status, .learn-status, .speak-status").remove(),d.find(".play-icon").after(c)}})})});var f=e.get_videoid(c),g=".thumb-frame[href$="+f+"] .watch-status.completed",h={partnerKey:e.consumerkey,partnerSdkToken:e.sdktoken,siteLanguage:e.sitelanguage,container:e.playercontainer,autoStart:a(g).length,interstitialsEnabled:!0,dialogId:f,learnMode:!0,speakMode:!0,quizMode:!0,width:640},i=window.outerWidth-a("#"+e.playercontainer).offset().left-24;h.width>i?h.width=i:i>1e3?h.width=1e3:h.height=655,window.ECSDK.loadWidget("player",h)},e.fetch_videos=function(b,c,d,f){var g=new RegExp("[, \\t\\r\\n]+","g"),h=d.replace(g,",");e.set_search_params(b,c,h,f);var i={dialogIDs:h,page:e.searchpage,pageSize:e.searchsize,siteLanguage:e.siteanguage};a.ajax({url:e.fetchurl,type:"GET",data:i,dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function(a){e.format_results(a)}})},e.search_videos=function(b,c,d,f){e.set_search_params(b,c,d,f);var g={term:e.searchterm,page:e.searchpage,pageSize:e.searchsize};f&&(g.difficulty=f),e.searchterm&&a.ajax({url:e.searchurl,type:"GET",data:g,dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function(a){e.format_results(a)}})},e.set_search_params=function(a,b,c,d){e.isNotNum(a)?(e.searchpage=0,e.searchterm="",e.searchlevel=""):e.searchpage=parseInt(a),b&&(e.searchsize=parseInt(b)),c&&(e.searchterm=c),d&&(e.searchlevel=d)},e.format_results=function(b){var f="";if(!b||!b.results||0==b.results.length)return f;var g=e.pagingbar(b.count);f+=g;for(var h=e.get_videoids(),i=0;i<b.results.length;i++){var j=b.results[i].value.dialogID.toString();h.indexOf(j)<0&&(f+=e.format_result(b.results[i]))}f+=g,a(".search-results").html(f),c.get_string("xitemsfound",e.plugin,e.formatnumber(b.count)).done(function(b){a(".search-results").prepend(d.tag("div",b,{"class":"itemsfound"}))});for(var i=0;i<b.results.length;i++){var k=b.results[i].value,l={dialogId:k.dialogID,title:k.title,duration:k.duration,difficulty:k.difficulty,dialogURL:k.dialogURL,thumbnailURL:k.thumbnailURL},j="#id_add_video_"+l.dialogId;a(j).data(l),a(j).click(function(a){e.add_video(a,this)}),a(j).siblings(".result-info").find(".icon").click(function(){var b=a(this).closest(".result-info").siblings(".result-add").prop("id");b=e.get_videoid_from_id(b);var c=Math.min(640,window.innerWidth),d=Math.min(480,window.innerHeight),f=window.outerWidth/2+window.screenX-c/2,g=window.outerHeight/2+window.screenY-d/2,h="width="+c+",height="+d+",top="+g+",left="+f,i=window.open(e.videoinfourl+"/"+b,e.targetwindow,h);i.focus&&i.focus()})}a(".pagingbar").find(".pagenumber:not(.currentpage)").click(function(){var b=a(this).text()-1;e.search_videos(b)})},e.get_videoids=function(){var b=[];return a(".englishcentral_videos .activity-title").each(function(){b.push(e.get_videoid(this))}),b},e.get_videoid=function(b){return e.get_videoid_from_href(a(b).prop("href"))},e.get_videoid_from_href=function(a){return a.replace(new RegExp("^.*/"),"")},e.get_videoid_from_id=function(a){return a.replace(new RegExp("^.*_"),"")},e.pagingbar=function(a){var b="";if(a){var c=e.searchsize,f=Math.ceil(a/c)-1;if(f>0){var g=0,h=e.searchpage,i=Math.max(g,e.searchpage-4),j=Math.min(f,Math.max(9,e.searchpage+4));g<i&&(b+=d.tag("span",g+1,{"class":"pagenumber"}),i-g>1&&(b+=d.tag("span","...",{"class":"pageseparator"})));for(var k=i;k<=j;k++){var l="pagenumber";k==h&&(l+=" currentpage"),b+=d.tag("span",k+1,{"class":l})}j<f&&(f-j>1&&(b+=d.tag("span","...",{"class":"pageseparator"})),b+=d.tag("span",f+1,{"class":"pagenumber"}))}}return b&&(b=d.tag("div",b,{"class":"pagingbar"})),b},e.formatnumber=function(a,b){"undefined"==typeof b&&(b=","),"number"==typeof a&&(a=a.toString());var c=new RegExp("\\B(?=(\\d{3})+(?!\\d))","g");return a.replace(c,b)},e.add_video=function(b,c){a.ajax({url:e.viewajaxurl,data:{id:e.cmid,data:a(c).data(),action:"addvideo",sesskey:e.moodlesesskey},dataType:"html",success:function(b){a(b).insertBefore(".removevideo").find("a").click(function(a){return e.play_video(a,this),a.stopPropagation(),a.preventDefault(),!1})}}),a(c).closest(".result-item").fadeTo(1e3,.01,function(){a(this).slideUp(150,function(){a(this).remove()})})},e.format_result=function(a){if(e.isNotNum(a.value.difficulty)||a.value.difficulty<1||a.value.difficulty>7)a.value.difficulty=0,a.difficulty="unknown";else switch(!0){case a.value.difficulty<=2:a.difficulty="beginner";break;case a.value.difficulty<=4:a.difficulty="intermediate";break;case a.value.difficulty<=7:a.difficulty="advanced"}var b="";return b+=e.format_add(a),b+=e.format_thumb(a),b+=e.format_info(a),d.tag("div",b,{"class":"result-item"})},e.format_add=function(b){var c=a(".removevideo img").prop("src").replace("removevideo","add"),f=d.emptytag("img",{src:c,title:e.str.addthisvideo});return d.tag("div",f,{"class":"result-add",id:"id_add_video_"+b.value.dialogID})},e.format_thumb=function(a){var b=a.value.duration.replace(new RegExp("^00:"),""),c="";return c+=d.starttag("a",{"class":"thumb-frame",href:a.value.dialogURL,style:"background-image: url('"+a.value.thumbnailURL+"')"}),c+=d.tag("div",a.value.difficulty,{"class":"result-difficulty "+a.difficulty}),c+=d.tag("div",b,{"class":"result-duration"}),c+=d.endtag("a"),d.tag("div",c,{"class":"result-thumb"})},e.format_info=function(b){var c="",f=a(".removevideo img").prop("src").replace("removevideo","i/info").replace("mod_englishcentral","core"),g=d.emptytag("img",{src:f,"class":"icon"}),h=b.value.title;return b.highlights.en_name&&(h=b.highlights.en_name[0]),c+=d.tag("h2",h+g,{"class":"result-title"}),c+=e.format_details(b),d.tag("div",c,{"class":"result-info"})},e.format_details=function(a){var b="";return b+=e.format_goalstopics(a.value.goals,a.value.topics,a.difficulty),b+=e.format_description(a.value.description),b+=e.format_transcript(a.highlights.transcript),d.tag("dl",b,{"class":"result-details"})},e.format_copyright=function(a){return a&&a.length?e.format_detail("copyright",a):""},e.format_goalstopics=function(a,b,c){var f=[];if(a&&a.length)for(var g=0;g<a.length;g++)f.push(a[g].title);if(b&&b.length)for(var g=0;g<b.length;g++)f.push(b[g].name);return 0==f.length?"":(f=f.join(", "),f+=d.tag("span",e.str[c],{"class":"result-level "+c}),e.format_detail("topics",f))},e.format_description=function(a){return a&&a.length?e.format_detail("description",a):""},e.format_transcript=function(a){if(a&&a.length){var b="...",c=new RegExp("//","g");return e.format_detail("transcript",b+a[0].replace(c,b)+b)}return""},e.format_detail=function(a,b){var c="";return c+=d.tag("dt",e.str[a],{"class":"result-label "+a}),c+=d.tag("dd",b,{"class":"result-value "+a})},e.isNotNum=function(a){switch(typeof a){case"number":return!1;case"string":return!a.match(new RegExp("^[0-9]+$"));default:return!0}},e});