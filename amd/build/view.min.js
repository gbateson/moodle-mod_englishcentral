function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("mod_englishcentral/view",["jquery","jqueryui","core/str","mod_englishcentral/html"],function(a,b,c,d){var e={plugin:"mod_englishcentral",playercontainer:"id_playercontainer",progresscontainer:"id_progresscontainer",searchcontainer:"id_searchcontainer",searchpage:0,searchsize:20,searchterm:"",searchlevel:"",str:{}};c.get_strings([{key:"addthisvideo",component:e.plugin},{key:"advanced",component:e.plugin},{key:"beginner",component:e.plugin},{key:"confirmremovevideo",component:e.plugin},{key:"copyright",component:e.plugin},{key:"description",component:e.plugin},{key:"duration",component:"search"},{key:"error",component:"error"},{key:"goals",component:e.plugin},{key:"hideadvanced",component:"form"},{key:"intermediate",component:e.plugin},{key:"level",component:e.plugin},{key:"ok",component:"moodle"},{key:"search",component:"moodle"},{key:"showadvanced",component:"form"},{key:"topics",component:e.plugin},{key:"transcript",component:e.plugin},{key:"videosearch",component:e.plugin},{key:"videosearchhelp",component:e.plugin},{key:"videosearchprompt",component:e.plugin}]).done(function(a){var b=0;e.str.addthisvideo=a[b++];e.str.advanced=a[b++];e.str.beginner=a[b++];e.str.confirmremovevideo=a[b++];e.str.copyright=a[b++];e.str.description=a[b++];e.str.duration=a[b++];e.str.error=a[b++];e.str.goals=a[b++];e.str.hideadvanced=a[b++];e.str.intermediate=a[b++];e.str.level=a[b++];e.str.ok=a[b++];e.str.search=a[b++];e.str.showadvanced=a[b++];e.str.topics=a[b++];e.str.transcript=a[b++];e.str.videosearch=a[b++];e.str.videosearchhelp=a[b++];e.str.videosearchprompt=a[b++]});e.init=function(b){for(var c in b){e[c]=b[c]}e.getoptions=a.Deferred();a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,action:"getoptions",sesskey:e.moodlesesskey},dataType:"json",success:function success(a){for(var b in a){e[b]=a[b]}e.getoptions.resolve()}});e.ECSDK=a.Deferred();a.when(e.getoptions).done(function(){if(1==e.sdkmode){e.sdkurl="https://www.qaenglishcentral.com"}else{e.sdkurl="https://www.englishcentral.com"}if("JSDK2"==e.sdkversion){e.sdkurl+="/partnersdk/sdk.js"}else{e.sdkurl+="/dist/sdk/sdk.js"}a.ajax({url:e.sdkurl,dataType:"script",cache:!0}).done(function(){e.ECSDK.resolve(window.ECSDK)})});a(".activity-title, .thumb-frame").click(function(a){e.play_video(a,this);a.stopPropagation();a.preventDefault();return!1});a(".englishcentral_videos").sortable({cursor:"move",items:".activity-thumbnail",update:function update(b,c){var d=c.item.find(".activity-title").data("url"),f={dialogId:e.get_videoid_from_url(d),sortorder:c.item.index()+1};a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,data:f,action:"sortvideo",sesskey:e.moodlesesskey},dataType:"html",success:function success(b){if(b){a("#"+e.playercontainer).html(b)}}})}});a(".removevideo").droppable({drop:function drop(b,c){if(confirm(e.str.confirmremovevideo)){c.draggable.remove();var d=c.draggable.find(".activity-title").data("url"),f={dialogId:e.get_videoid_from_url(d)};a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,data:f,action:"removevideo",sesskey:e.moodlesesskey},dataType:"html",success:function success(b){if(b){a("#"+e.playercontainer).html(b)}}})}}});a("#"+e.searchcontainer+" .search-form").submit(function(b){e.clear_player_and_searchresults();var c=a("#id_searchterm").val(),d=a("[name='level[]']:checked").map(function(){return this.value}).get().join(",");if(""==c){a(".search-results").html(e.str.videosearchhelp)}else if(c.match(/^s*[0-9]+([, \t\r\n]+[0-9]+)*s*$/)){e.fetch_videos(null,null,c,d)}else{e.search_videos(null,null,c,d)}b.preventDefault()});a("#"+e.searchcontainer+" .search-advanced").click(function(){if(a(this).text()==e.str.showadvanced){a(this).text(e.str.hideadvanced)}else{a(this).text(e.str.showadvanced)}a("#"+e.searchcontainer+" .search-fields").find("dt:not(.visible), dd:not(.visible)").toggle()})};e.play_video=function(b,c){a.when(e.ECSDK,b,c).done(function(b,c,d){e.clear_player_and_searchresults();var f="";if(b.setOnProgressEventHandler){f="setOnProgressEventHandler"}else if(b.setOnModeEndHandler){f="setOnModeEndHandler"}if(f){b[f](function(b){switch(b.eventType){case"CompleteActivityWatch":case"LearnedWord":case"DialogLineSpeak":break;case"DialogLineWatch":var c=".thumb-frame[data-url$="+b.dialogID+"]";if(a(c+" .watch-status").length){return!1}break;case"CompleteActivityLearn":case"CompleteActivitySpeak":return!1;case"StartActivityWatch":case"StartActivityLearn":case"TypedWord":case"StudiedWord":case"StartActivitySpeak":return!1;default:break;}a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"storeresults",sesskey:e.moodlesesskey},dataType:"html"}).done(function(c){if(c.match(/^\{.*\}$/)){c=c.replace(/\n/g,"\\\\n");c=JSON.parse(c);if(c.error){c=c.error.replace(/\n/g,"<br>")}else{c=c.toString().substr(0,200);c="Sorry, there was an unknown error on the server.\n"+c}if(e.dialog){if(e.dialog.dialog("isOpen")){e.dialog.dialog("close")}}else{e.dialog=a("<div></div>").addClass("dialog");e.dialog.dialog({autoOpen:!1})}e.dialog.html(c);e.dialog.dialog("option","title",e.str.error);e.dialog.dialog("option","buttons",[{text:e.str.ok,click:function click(){a(this).dialog("close");var b=e.viewajaxurl.replace(".ajax","");window.location.href=b+"?id="+e.cmid}}]);e.dialog.dialog("open");return!1}if(0>c.indexOf("englishcentral_progress")){a(".englishcentral_progress").html(c)}else{a(".englishcentral_progress").replaceWith(c)}a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,data:{dialogID:b.dialogID,sdktoken:e.sdktoken},action:"showstatus",sesskey:e.moodlesesskey},dataType:"html"}).done(function(c){var d=a(".thumb-frame[data-url$="+b.dialogID+"]");d.find(".watch-status, .learn-status, .speak-status").remove();d.find(".play-icon").after(c)})})})}var g=e.get_videoid(d),h={partnerKey:e.consumerkey,partnerSdkToken:e.sdktoken,container:e.playercontainer,dialogId:g};if("JSDK3"==e.sdkversion){h.lang=e.sitelanguage}else{h.siteLanguage=e.sitelanguage;h.autoStart=a(".thumb-frame[data-url$="+g+"] .watch-status.completed").length;h.activityPanelEnabled=!1;h.interstitialsEnabled=!0;h.learnMode=!0;h.speakMode=!0;h.quizMode=!0;h.width=640;var i=window.outerWidth-a("#"+e.playercontainer).offset().left-24;if(h.width>i){h.width=i}else if(1e3<i){h.width=1e3}else{h.height=655}}b.loadWidget("player",h)})};e.clear_player_and_searchresults=function(){a("#"+e.playercontainer).html("");a("#"+e.searchcontainer+" .search-results").html("")};e.fetch_videos=function(b,c,d,f){var g=d.replace(/[, \t\r\n]+/g,",");e.set_search_params(b,c,g,f);var h={dialogIDs:g,page:e.searchpage,pageSize:e.searchsize,siteLanguage:e.siteanguage};a.ajax({url:e.fetchurl,type:"GET",data:h,dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function success(a){var b=!1;if(a&&0<a.length){b={count:a.length,results:[]};for(var c=0,d;c<a.length;c++){d={};d.en_name=["<em>"+a[c].title+"</em>"];d.en_topic=["<em>"+a[c].topics[0].name+"</em>"];d.en_description=[a[c].description];b.results.push({score:150,value:a[c],highlights:d})}}e.format_results(b)}})};e.search_videos=function(b,c,d,f){e.set_search_params(b,c,d,f);var g={term:e.searchterm,page:e.searchpage,pageSize:e.searchsize};if(f){g.difficulty=f}if(e.searchterm){a.ajax({url:e.searchurl,type:"GET",data:g,dataType:"json",headers:{Accept:e.accept1,Authorization:e.authorization,"Content-Type":"application/json"},success:function success(a){e.format_results(a)}})}};e.set_search_params=function(a,b,c,d){if(e.isNotNum(a)){e.searchpage=0;e.searchterm="";e.searchlevel=""}else{e.searchpage=parseInt(a)}if(b){e.searchsize=parseInt(b)}if(c){e.searchterm=c}if(d){e.searchlevel=d}};e.format_results=function(b){var f="";if(!b||!b.results||0==b.results.length){return f}var g=e.pagingbar(b.count);f+=g;for(var h=e.get_videoids(),j=0,k;j<b.results.length;j++){k=b.results[j].value.dialogID.toString();if(0>h.indexOf(k)){f+=e.format_result(b.results[j])}}f+=g;a(".search-results").html(f);c.get_string("xitemsfound",e.plugin,e.formatnumber(b.count)).done(function(b){a(".search-results").prepend(d.tag("div",b,{class:"itemsfound"}))});for(var j=0;j<b.results.length;j++){var l=b.results[j].value,m={dialogId:l.dialogID,title:l.title,duration:l.duration,difficulty:l.difficulty,dialogURL:l.dialogURL,thumbnailURL:l.thumbnailURL},k="#id_add_video_"+m.dialogId;a(k).data(m);a(k).click(function(a){e.add_video(a,this)});a(k).siblings(".result-thumb").click(function(){e.open_window(a(this).data("url"))});a(k).siblings(".result-info").find(".icon").click(function(){var b=a(this).closest(".result-info").siblings(".result-add").prop("id");e.open_window(e.videoinfourl+"/"+e.get_videoid_from_id(b))})}a(".pagingbar").find(".pagenumber:not(.currentpage)").click(function(){var b=a(this).text()-1;e.search_videos(b)})};e.get_videoids=function(){var b=[];a(".englishcentral_videos .activity-title").each(function(){b.push(e.get_videoid(this))});return b};e.get_videoid=function(b){var c=a(b).data("url");return e.get_videoid_from_url(c)};e.get_videoid_from_url=function(a){return a.replace(/^.*\//,"")};e.get_videoid_from_id=function(a){return a.replace(/^.*_/,"")};e.open_window=function(a){var b=Math.min(640,window.innerWidth),c=Math.min(480,window.innerHeight),d=window.outerWidth/2+window.screenX-b/2,f=window.outerHeight/2+window.screenY-c/2,g=window.open(a,e.targetwindow,"width="+b+",height="+c+",top="+f+",left="+d);if(g.focus){g.focus()}};e.pagingbar=function(a){var b="";if(a){var c=e.searchsize,f=Math.ceil(a/c)-1;if(0<f){var g=e.searchpage,h=Math.max(0,e.searchpage-4),i=Math.min(f,Math.max(9,e.searchpage+4));if(0<h){b+=d.tag("span",1,{class:"pagenumber"});if(1<h-0){b+=d.tag("span","...",{class:"pageseparator"})}}for(var j=h,k;j<=i;j++){k="pagenumber";if(j==g){k+=" currentpage"}b+=d.tag("span",j+1,{class:k})}if(i<f){if(1<f-i){b+=d.tag("span","...",{class:"pageseparator"})}b+=d.tag("span",f+1,{class:"pagenumber"})}}}if(b){b=d.tag("div",b,{class:"pagingbar"})}return b};e.formatnumber=function(a,b){if("undefined"==typeof b){b=","}if("number"==typeof a){a=a.toString()}return a.replace(/\B(?=(\d{3})+(?!\d))/g,b)};e.add_video=function(b,c){a.ajax({url:e.viewajaxurl,type:"POST",data:{id:e.cmid,data:a(c).data(),action:"addvideo",sesskey:e.moodlesesskey},dataType:"html",success:function success(b){a(b).insertBefore(".removevideo").find(".thumb-frame").click(function(a){e.play_video(a,this);a.stopPropagation();a.preventDefault();return!1})}});a(c).closest(".result-item").fadeTo(1e3,.01,function(){a(this).slideUp(150,function(){a(this).remove()})})};e.format_result=function(a){if(e.isNotNum(a.value.difficulty)||1>a.value.difficulty||7<a.value.difficulty){a.value.difficulty=0;a.difficulty="unknown"}else{switch(!0){case 2>=a.value.difficulty:a.difficulty="beginner";break;case 4>=a.value.difficulty:a.difficulty="intermediate";break;case 7>=a.value.difficulty:a.difficulty="advanced";break;}}var b="";b+=e.format_add(a);b+=e.format_thumb(a);b+=e.format_info(a);return d.tag("div",b,{class:"result-item"})};e.format_add=function(b){var c=a(".removevideo img").prop("src").replace("removevideo","add"),f=d.emptytag("img",{src:c,title:e.str.addthisvideo});return d.tag("div",f,{class:"result-add",id:"id_add_video_"+b.value.dialogID})};e.format_thumb=function(a){var b=a.value.duration.replace(/^00:/,""),c="";c+=d.starttag("div",{class:"thumb-frame",style:"background-image: url('"+a.value.thumbnailURL+"')"});c+=d.tag("div",a.value.difficulty,{class:"result-difficulty "+a.difficulty});c+=d.tag("div",b,{class:"result-duration"});c+=d.endtag("div");return d.tag("div",c,{class:"result-thumb","data-url":a.value.dialogURL})};e.format_info=function(b){var c="",f=a(".removevideo img").prop("src").replace("removevideo","i/info").replace("mod_englishcentral","core"),g=d.emptytag("img",{src:f,class:"icon"}),h=b.value.title;if(b.highlights.en_name){h=b.highlights.en_name[0]}c+=d.tag("h2",h+g,{class:"result-title"});c+=e.format_details(b);return d.tag("div",c,{class:"result-info"})};e.format_details=function(a){var b="";b+=e.format_goalstopics(a.value.goals,a.value.topics,a.difficulty);b+=e.format_description(a.value.description);b+=e.format_transcript(a.highlights.transcript);return d.tag("dl",b,{class:"result-details"})};e.format_copyright=function(a){if(a&&a.length){return e.format_detail("copyright",a)}return""};e.format_goalstopics=function(a,b,c){var f=[];if(a&&a.length){for(var g=0;g<a.length;g++){f.push(a[g].title)}}if(b&&b.length){for(var g=0;g<b.length;g++){f.push(b[g].name)}}if(0==f.length){return""}f=f.join(", ");f+=d.tag("span",e.str[c],{class:"result-level "+c});return e.format_detail("topics",f)};e.format_description=function(a){if(a&&a.length){return e.format_detail("description",a)}return""};e.format_transcript=function(a){if(a&&a.length){return e.format_detail("transcript","..."+a[0].replace(/\/\//g,"...")+"...")}return""};e.format_detail=function(a,b){var c="";c+=d.tag("dt",e.str[a],{class:"result-label "+a});c+=d.tag("dd",b,{class:"result-value "+a});return c};e.isNotNum=function(a){switch(_typeof(a)){case"number":return!1;case"string":return!a.match(/^[0-9]+$/);default:return!0;}};return e});
//# sourceMappingURL=view.min.js.map
