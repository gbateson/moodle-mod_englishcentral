function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("mod_englishcentral/view",["jquery","jqueryui","core/log","core/str","mod_englishcentral/html"],function(a,b,c,d,e){var f={plugin:"mod_englishcentral",playercontainer:"id_playercontainer",progresscontainer:"id_progresscontainer",searchcontainer:"id_searchcontainer",searchpage:0,searchsize:20,searchterm:"",searchlevel:"",str:{}};d.get_strings([{key:"addthisvideo",component:f.plugin},{key:"advanced",component:f.plugin},{key:"beginner",component:f.plugin},{key:"confirmremovevideo",component:f.plugin},{key:"copyright",component:f.plugin},{key:"description",component:f.plugin},{key:"duration",component:"search"},{key:"error",component:"error"},{key:"goals",component:f.plugin},{key:"hideadvanced",component:"form"},{key:"intermediate",component:f.plugin},{key:"level",component:f.plugin},{key:"ok",component:"moodle"},{key:"search",component:"moodle"},{key:"showadvanced",component:"form"},{key:"topics",component:f.plugin},{key:"transcript",component:f.plugin},{key:"videosearch",component:f.plugin},{key:"videosearchhelp",component:f.plugin},{key:"videosearchprompt",component:f.plugin}]).done(function(a){var b=0;f.str.addthisvideo=a[b++];f.str.advanced=a[b++];f.str.beginner=a[b++];f.str.confirmremovevideo=a[b++];f.str.copyright=a[b++];f.str.description=a[b++];f.str.duration=a[b++];f.str.error=a[b++];f.str.goals=a[b++];f.str.hideadvanced=a[b++];f.str.intermediate=a[b++];f.str.level=a[b++];f.str.ok=a[b++];f.str.search=a[b++];f.str.showadvanced=a[b++];f.str.topics=a[b++];f.str.transcript=a[b++];f.str.videosearch=a[b++];f.str.videosearchhelp=a[b++];f.str.videosearchprompt=a[b++]});f.init=function(b){for(var c in b){f[c]=b[c]}f.getoptions=a.Deferred();a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,action:"getoptions",sesskey:f.moodlesesskey},dataType:"json",success:function success(a){for(var b in a){f[b]=a[b]}f.getoptions.resolve()}});f.ECSDK=a.Deferred();a.when(f.getoptions).done(function(){if(1==f.sdkmode){f.sdkurl="https://www.qaenglishcentral.com"}else{f.sdkurl="https://www.englishcentral.com"}if("JSDK2"==f.sdkversion){f.sdkurl+="/partnersdk/sdk.js"}else{f.sdkurl+="/dist/sdk/sdk.js"}a.ajax({url:f.sdkurl,dataType:"script",cache:!0}).done(function(){f.ECSDK.resolve(window.ECSDK)})});a(".activity-title, .thumb-frame").click(function(a){f.play_video(a,this);a.stopPropagation();a.preventDefault();return!1});a(".englishcentral_videos").sortable({cursor:"move",items:".activity-thumbnail",update:function update(b,c){var d=c.item.find(".activity-title").data("url"),e={dialogId:f.get_videoid_from_url(d),sortorder:c.item.index()+1};a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,data:e,action:"sortvideo",sesskey:f.moodlesesskey},dataType:"html",success:function success(b){if(b){a("#"+f.playercontainer).html(b)}}})}});a(".removevideo").droppable({drop:function drop(b,c){if(confirm(f.str.confirmremovevideo)){c.draggable.remove();var d=c.draggable.find(".activity-title").data("url"),e={dialogId:f.get_videoid_from_url(d)};a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,data:e,action:"removevideo",sesskey:f.moodlesesskey},dataType:"html",success:function success(b){if(b){a("#"+f.playercontainer).html(b)}}})}}});a("#"+f.searchcontainer+" .search-form").submit(function(b){f.clear_player_and_searchresults();var c=a("#id_searchterm").val(),d=a("[name='level[]']:checked").map(function(){return this.value}).get().join(",");if(""==c){a(".search-results").html(f.str.videosearchhelp)}else if(c.match(/^s*[0-9]+([, \t\r\n]+[0-9]+)*s*$/)){f.fetch_videos(null,null,c,d)}else{f.search_videos(null,null,c,d)}b.preventDefault()});a("#"+f.searchcontainer+" .search-advanced").click(function(){if(a(this).text()==f.str.showadvanced){a(this).text(f.str.hideadvanced)}else{a(this).text(f.str.showadvanced)}a("#"+f.searchcontainer+" .search-fields").find("dt:not(.visible), dd:not(.visible)").toggle()})};f.play_video=function(b,d){a.when(f.ECSDK,b,d).done(function(b,d,e){f.clear_player_and_searchresults();var g="";if(b.setOnProgressEventHandler){g="setOnProgressEventHandler"}else if(b.setOnModeEndHandler){g="setOnModeEndHandler"}if(g){b[g](function(b){c.debug(b);switch(b.eventType){case"CompleteActivityWatch":case"LearnedWord":case"DialogLineSpeak":break;case"DialogLineWatch":var d=".thumb-frame[data-url$="+b.dialogID+"]";if(a(d+" .watch-status").length){return!1}break;case"CompleteActivityLearn":case"CompleteActivitySpeak":return!1;case"StartActivityWatch":case"StartActivityLearn":case"TypedWord":case"StudiedWord":case"StartActivitySpeak":return!1;default:break;}a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,data:{dialogID:b.dialogID,sdktoken:f.sdktoken},action:"storeresults",sesskey:f.moodlesesskey},dataType:"html"}).done(function(c){if(c.match(/^\{.*\}$/)){c=c.replace(/\n/g,"\\\\n");c=JSON.parse(c);if(c.error){c=c.error.replace(/\n/g,"<br>")}else{c=c.toString().substr(0,200);c="Sorry, there was an unknown error on the server.\n"+c}if(f.dialog){if(f.dialog.dialog("isOpen")){f.dialog.dialog("close")}}else{f.dialog=a("<div></div>").addClass("dialog");f.dialog.dialog({autoOpen:!1})}f.dialog.html(c);f.dialog.dialog("option","title",f.str.error);f.dialog.dialog("option","buttons",[{text:f.str.ok,click:function click(){a(this).dialog("close");var b=f.viewajaxurl.replace(".ajax","");window.location.href=b+"?id="+f.cmid}}]);f.dialog.dialog("open");return!1}if(0>c.indexOf("englishcentral_progress")){a(".englishcentral_progress").html(c)}else{a(".englishcentral_progress").replaceWith(c)}a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,data:{dialogID:b.dialogID,sdktoken:f.sdktoken},action:"showstatus",sesskey:f.moodlesesskey},dataType:"html"}).done(function(c){var d=a(".thumb-frame[data-url$="+b.dialogID+"]");d.find(".watch-status, .learn-status, .speak-status").remove();d.find(".play-icon").after(c)})})})}var h=f.get_videoid(e),i={partnerKey:f.consumerkey,partnerSdkToken:f.sdktoken,container:f.playercontainer,dialogId:h};if("JSDK3"==f.sdkversion){i.lang=f.sitelanguage}else{i.siteLanguage=f.sitelanguage;i.autoStart=a(".thumb-frame[data-url$="+h+"] .watch-status.completed").length;i.activityPanelEnabled=!1;i.interstitialsEnabled=!0;i.learnMode=!0;i.speakMode=!0;i.quizMode=!0;i.width=640;var j=window.outerWidth-a("#"+f.playercontainer).offset().left-24;if(i.width>j){i.width=j}else if(1e3<j){i.width=1e3}else{i.height=655}}b.loadWidget("player",i)})};f.clear_player_and_searchresults=function(){a("#"+f.playercontainer).html("");a("#"+f.searchcontainer+" .search-results").html("")};f.fetch_videos=function(b,c,d,e){var g=d.replace(/[, \t\r\n]+/g,",");f.set_search_params(b,c,g,e);var h={dialogIDs:g,page:f.searchpage,pageSize:f.searchsize,siteLanguage:f.siteanguage};a.ajax({url:f.fetchurl,type:"GET",data:h,dataType:"json",headers:{Accept:f.accept1,Authorization:f.authorization,"Content-Type":"application/json"},success:function success(a){var b=!1;if(a&&0<a.length){b={count:a.length,results:[]};for(var c=0,d;c<a.length;c++){d={};d.en_name=["<em>"+a[c].title+"</em>"];d.en_topic=["<em>"+a[c].topics[0].name+"</em>"];d.en_description=[a[c].description];b.results.push({score:150,value:a[c],highlights:d})}}f.format_results(b)}})};f.search_videos=function(b,c,d,e){f.set_search_params(b,c,d,e);var g={term:f.searchterm,page:f.searchpage,pageSize:f.searchsize};if(e){g.difficulty=e}if(f.searchterm){a.ajax({url:f.searchurl,type:"GET",data:g,dataType:"json",headers:{Accept:f.accept1,Authorization:f.authorization,"Content-Type":"application/json"},success:function success(a){f.format_results(a)}})}};f.set_search_params=function(a,b,c,d){if(f.isNotNum(a)){f.searchpage=0;f.searchterm="";f.searchlevel=""}else{f.searchpage=parseInt(a)}if(b){f.searchsize=parseInt(b)}if(c){f.searchterm=c}if(d){f.searchlevel=d}};f.format_results=function(b){var c="";if(!b||!b.results||0==b.results.length){return c}var g=f.pagingbar(b.count);c+=g;for(var h=f.get_videoids(),j=0,k;j<b.results.length;j++){k=b.results[j].value.dialogID.toString();if(0>h.indexOf(k)){c+=f.format_result(b.results[j])}}c+=g;a(".search-results").html(c);d.get_string("xitemsfound",f.plugin,f.formatnumber(b.count)).done(function(b){a(".search-results").prepend(e.tag("div",b,{class:"itemsfound"}))});for(var j=0;j<b.results.length;j++){var l=b.results[j].value,m={dialogId:l.dialogID,title:l.title,duration:l.duration,difficulty:l.difficulty,dialogURL:l.dialogURL,thumbnailURL:l.thumbnailURL},k="#id_add_video_"+m.dialogId;a(k).data(m);a(k).click(function(a){f.add_video(a,this)});a(k).siblings(".result-thumb").click(function(){f.open_window(a(this).data("url"))});a(k).siblings(".result-info").find(".icon").click(function(){var b=a(this).closest(".result-info").siblings(".result-add").prop("id");f.open_window(f.videoinfourl+"/"+f.get_videoid_from_id(b))})}a(".pagingbar").find(".pagenumber:not(.currentpage)").click(function(){var b=a(this).text()-1;f.search_videos(b)})};f.get_videoids=function(){var b=[];a(".englishcentral_videos .activity-title").each(function(){b.push(f.get_videoid(this))});return b};f.get_videoid=function(b){var c=a(b).data("url");return f.get_videoid_from_url(c)};f.get_videoid_from_url=function(a){return a.replace(/^.*\//,"")};f.get_videoid_from_id=function(a){return a.replace(/^.*_/,"")};f.open_window=function(a){var b=Math.min(640,window.innerWidth),c=Math.min(480,window.innerHeight),d=window.outerWidth/2+window.screenX-b/2,e=window.outerHeight/2+window.screenY-c/2,g=window.open(a,f.targetwindow,"width="+b+",height="+c+",top="+e+",left="+d);if(g.focus){g.focus()}};f.pagingbar=function(a){var b="";if(a){var c=f.searchsize,d=Math.ceil(a/c)-1;if(0<d){var g=f.searchpage,h=Math.max(0,f.searchpage-4),i=Math.min(d,Math.max(9,f.searchpage+4));if(0<h){b+=e.tag("span",1,{class:"pagenumber"});if(1<h-0){b+=e.tag("span","...",{class:"pageseparator"})}}for(var j=h,k;j<=i;j++){k="pagenumber";if(j==g){k+=" currentpage"}b+=e.tag("span",j+1,{class:k})}if(i<d){if(1<d-i){b+=e.tag("span","...",{class:"pageseparator"})}b+=e.tag("span",d+1,{class:"pagenumber"})}}}if(b){b=e.tag("div",b,{class:"pagingbar"})}return b};f.formatnumber=function(a,b){if("undefined"==typeof b){b=","}if("number"==typeof a){a=a.toString()}return a.replace(/\B(?=(\d{3})+(?!\d))/g,b)};f.add_video=function(b,c){a.ajax({url:f.viewajaxurl,type:"POST",data:{id:f.cmid,data:a(c).data(),action:"addvideo",sesskey:f.moodlesesskey},dataType:"html",success:function success(b){a(b).insertBefore(".removevideo").find(".thumb-frame").click(function(a){f.play_video(a,this);a.stopPropagation();a.preventDefault();return!1})}});a(c).closest(".result-item").fadeTo(1e3,.01,function(){a(this).slideUp(150,function(){a(this).remove()})})};f.format_result=function(a){if(f.isNotNum(a.value.difficulty)||1>a.value.difficulty||7<a.value.difficulty){a.value.difficulty=0;a.difficulty="unknown"}else{switch(!0){case 2>=a.value.difficulty:a.difficulty="beginner";break;case 4>=a.value.difficulty:a.difficulty="intermediate";break;case 7>=a.value.difficulty:a.difficulty="advanced";break;}}var b="";b+=f.format_add(a);b+=f.format_thumb(a);b+=f.format_info(a);return e.tag("div",b,{class:"result-item"})};f.format_add=function(b){var c=a(".removevideo img").prop("src").replace("removevideo","add"),d=e.emptytag("img",{src:c,title:f.str.addthisvideo});return e.tag("div",d,{class:"result-add",id:"id_add_video_"+b.value.dialogID})};f.format_thumb=function(a){var b=a.value.duration.replace(/^00:/,""),c="";c+=e.starttag("div",{class:"thumb-frame",style:"background-image: url('"+a.value.thumbnailURL+"')"});c+=e.tag("div",a.value.difficulty,{class:"result-difficulty "+a.difficulty});c+=e.tag("div",b,{class:"result-duration"});c+=e.endtag("div");return e.tag("div",c,{class:"result-thumb","data-url":a.value.dialogURL})};f.format_info=function(b){var c="",d=a(".removevideo img").prop("src").replace("removevideo","i/info").replace("mod_englishcentral","core"),g=e.emptytag("img",{src:d,class:"icon"}),h=b.value.title;if(b.highlights.en_name){h=b.highlights.en_name[0]}c+=e.tag("h2",h+g,{class:"result-title"});c+=f.format_details(b);return e.tag("div",c,{class:"result-info"})};f.format_details=function(a){var b="";b+=f.format_goalstopics(a.value.goals,a.value.topics,a.difficulty);b+=f.format_description(a.value.description);b+=f.format_transcript(a.highlights.transcript);return e.tag("dl",b,{class:"result-details"})};f.format_copyright=function(a){if(a&&a.length){return f.format_detail("copyright",a)}return""};f.format_goalstopics=function(a,b,c){var d=[];if(a&&a.length){for(var g=0;g<a.length;g++){d.push(a[g].title)}}if(b&&b.length){for(var g=0;g<b.length;g++){d.push(b[g].name)}}if(0==d.length){return""}d=d.join(", ");d+=e.tag("span",f.str[c],{class:"result-level "+c});return f.format_detail("topics",d)};f.format_description=function(a){if(a&&a.length){return f.format_detail("description",a)}return""};f.format_transcript=function(a){if(a&&a.length){return f.format_detail("transcript","..."+a[0].replace(/\/\//g,"...")+"...")}return""};f.format_detail=function(a,b){var c="";c+=e.tag("dt",f.str[a],{class:"result-label "+a});c+=e.tag("dd",b,{class:"result-value "+a});return c};f.isNotNum=function(a){switch(_typeof(a)){case"number":return!1;case"string":return!a.match(/^[0-9]+$/);default:return!0;}};return f});
//# sourceMappingURL=view.min.js.map
